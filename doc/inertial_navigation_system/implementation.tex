
\section{Implementation}\label{sec:implementation}
The sensors used were the VN-100 inertial measurement unit from VectorNav Technologies and the 8088 000-112 Fiber optic gyro from SAAB. The VN-100 (refereed to as the "IMU") is a digital sensor and provides a serial interface. The IMU's  maximum output rate of 200 samples per second is used. The IMU can output angular rates of rotation, orientation, acceleration as well as the output from the magnetometer. The orientation can be given in several different formats including quaternion, directional cosine orientation matrix and yaw, pitch and roll readings. Yaw, pitch and roll readings were chosen since this is the most compact way of describing the orientation.

The Fiber optic gyro (refereed to as the "FOG") is an analog sensor and gives a analog voltage output proportional to the angular speed of rotation. The analog output is filtered and sampled by a analog-to-digital converter (ADC) that interfaces with the AT90CAN128 on the Generic CAN controller via SPI.

The software running on the Generic CAN controller is called AT90CAN\_Ins\_Controller and handles communication with the IMU and the ADC that is connected to the FOG as well as outputs the measurements from the sensors onto the CAN bus.

\subsection{Inertial measurement unit}
The IMU is powered by the +5V feed from the Generic CAN controller. It provides a serial interface at both 3.3 Volt TTL levels and RS-232 levels, neither of which can be directly connected to Generic CAN controller since the UART busses on the AT90CAN128 microcontroller work at +5 Volt TTL levels. A level change was consequently needed. The MAX232 driver/receiver was chosen to convert between RS-232 levels and +5 Volt TTL levels since it needs only a 5 Volt supply. \newline
The IMU has one output pin called \emph{SYNC\_OUT} that can be configured to output a synchronization pulse whenever the IMU has completed a measurement. The SYNC\_OUT pin is connected to Port, D pin 2 on the AT90CAN128. This pin is activates the \emph{external interrupt 2}. \newline
The above configuration enables an interrupt service routine to be activated every time the IMU has made a measurement.\newline 
\emph{Please note that this pin also is the receive pin on the UART1 bus. Hence UART1 is therefore inactivated.} 

\subsubsection{Software interface}
As mentioned, the IMU communicates over a serial interface and is connected to the UART0 bus of the AT90CAN128. The AT90CAN\_Ins\_Controller software starts by initiating the UART to run at a baud-rate of 115200 baud. \newline
The default mode of the IMU outputs data at an undesired rate and format. Hence a set of commands, shown in chronological order in Table \ref{table:IMU_messages}, need to be sent. The default baud-rate of the IMU is 115200 baud which is too slow for the highest output, for this reason a command to switch the baud-rate is sent. \newline
The commands sent to the IMU start with a dollarsign "\$", followed by "VNRRG" that indicates that one wants to write to a register, a comma, a two digit number indicating the ID of the register, a comma, register specific parameters, an asterisk "*", a checksum and finally a newline character. 
The first message sent turns off the use of checksums since checksums were not considered to be needed. \newline
After the messages are sent the UART bus is reinitialized to run at 230.4 kBaud. The receive buffer is flushed to remove any old irrelevant data.

As mentioned, an external interrupt service routine (ISR) is activated each time the IMU finishes a measurement. Since the process of receiving and interpret a response from the IMU is to computationally demanding to be done in an ISR. Hence, the ISR will only set a boolean flag when an interrupt occurs. The main program will then read this flag and handle the IMU data. \newline



\begin{table*}
\centering
    \caption{Messages sent to initiate the IMU}
    \begin{tabular}{|p{2.5cm}|l|p{6cm}|} \hline
    \label{table:IMU_messages}
    	\textbf{Command name} & \textbf{Command string} & \textbf{Meaning} \\ \hline
        Communication Protocol Control & \$VNWRG,30,0,0,0,0,0,0,1 *68 & Turns of checksums, sets error messages to be returned by IMU if incorrect messages are received, and turns off some other functions. \\ \hline
        Async Data Output Type Register & \$VNWRG,06,0* & Turns off asynchronous output to avoid unwanted data. \\ \hline
        Async Data Output Frequency Register & \$VNWRG,07,200* & Sets asynchronous output rate to 200 Hz. \\ \hline        
        Synchronization Control & \$VNWRG,32,3,0,1,0,3,1,1,500000,0* & Configures the synchronization pulse. \\ \hline
        VPE Basic Control & \$VNWRG,35,1,2,1,1* & Various settings for the attitude filtering algorithm. \\ \hline
        Async Data Output Type Register & \$VNWRG,06,16* & Sets asynchronous output to "Yaw, Pitch, Roll, Body True Acceleration, and Angular Rates". \\ \hline
        Serial Baud Rate Register & \$VNWRG,05,230400* & Sets the baud-rate to 230.4 kBaud. \\ \hline        
    \end{tabular}
\end{table*}




\subsection{Fiber optic gyroscope}
Since the Fiber optic gyroscope is a high precision analog sensor great care has to be taken when designing its interface circuit in order to attain full precision. \newline
The accuracy of the FOG is highly dependent on the quality of the power supply, any noise on the power supply will decrease accuracy. The same need for accuracy is present in the analog to digital conversion. Fortunately, the manufacturer provided the Naiad AUV project with a schematic for the circuit that is to be used for the analog to digital conversion. The analog to digital converter (ADC) used was the ADS1255 extremely low-noise, 24-bit analog to digital converter which has an SPI interface.

\subsubsection{Power supply}
The FOG has three power lines, +12 Volts, -12 Volts and +5 Volts as well as a power ground and a signal ground. \newline
According to the manual of the FOG, the +5 Volt line is not allowed to be present without the +12 Volts and -12 Volts lines. This is ensured by using a PVG612 Photovoltaic Relay that is activated by a digital output from the AT90CAN128. This pin is set high after a delay after start up. \newline
In order to stabilize the supply voltage several capacitors are connected between each supply line and ground. These capacitors are placed as close to the FOG connector as possible and have very low equivalent series resistance (ESR) in order to remove as much noise as possible. 

Although the Generic CAN controller could supply the INS board with +12 Volts, this supply is not galvanically isolated from the supply voltage. For this reason only the 5 Volt supply, which is galvanically isolated, was used by the INS controller and consequently DC to DC conversion from 5 Volts to +12 and -12 Volts was needed. \newline
The User manual of the FOG specifies that low noise switching DC to DC converters with a switching frequency of at least 400 kHz is to be used. The LT1931 inverting DC to DC converter was used to supply -12 Volts. The LMR62014 step-up voltage regulator was chosen to supply +12 Volts. Both of which use switching frequencies well over 1 MHz.


\subsubsection{Analog to digital conversion}
Before analog to digital conversion, the analog output from the FOG is filtered to remove high frequency components that could otherwise give rise to aliasing distortion. This filter is included in the schematic provided by the manufacturer of the FOG and was not modified during the project. \newline
The THS4131 differential amplifier is the central component of the anti-aliasing filter. 

The analog to digital converter used in the circuit is the ADS1255. The ADS1255 is run at <INSERT SAMPLE RATE> samples pers second and has a resolution of 24 bits, however only about <INSERT EFFECTIVE RESOLUTION> bits is at this sample rate. \newline
The ADS1255 is supplied by both 5 Volts and as well as 3.3 Volts. For this reason the LM1117MP-3.3 linear voltage regulator was used to convert from 5 Volts to 3.3 Volts. 

Both the ADS1255 and the THS4131 require a voltage reference of 2.5 Volts. This voltage level needs to be very stable and noise free or accuracy of the whole circuit could be affected. The ADR421ARMZ ultraprecision, low noise voltage reference was used for this task.

\subsubsection{Software interface}
The analog to digital converter communicates with the AT90CAN128 using SPI...  <INSERT MORE TEXT ABOUT THE SPI COMMUNICATION WITH THE ADC!!!>







\newpage